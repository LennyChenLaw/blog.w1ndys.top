name: Hexo Deploy

on:
  push:
    branches:
      - main
env:
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v2
        with:
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@v1
        with:
          node-version: "20"

      - name: Setup Hexo
        env:
          ACTION_DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh/
          echo "$ACTION_DEPLOY_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          git config --global user.email "w1ndys@outlook.com"
          git config --global user.name "W1ndys"
          git config --global init.defaultBranch main
          npm install hexo-cli -g
          npm install

      - name: Deploy
        run: |
          hexo clean
          hexo generate
          hexo deploy

      - name: Deploy to ECS
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.USER_HOST }}
          username: ${{ secrets.USER_NAME }}
          password: ${{ secrets.USER_PASS }}
          port: 22
          script: |
            WORK_DIR="/tmp/blog-temp"
            TARGET_DIR="/opt/1panel/apps/openresty/openresty/www/sites/blog.w1ndys.top/index"
            REPO_URL="git@github.com:W1ndys/Blog.git"
            BACKUP_REPO_URL="https://ghfast.top/https://github.com/W1ndys/Blog.git"

            # 添加日志函数
            log() {
              echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
            }

            # 执行部署操作并捕获错误
            {
              log "开始部署流程..."
              
              # 清理并创建工作目录
              log "清理并创建工作目录: $WORK_DIR"
              rm -rf "$WORK_DIR" && \
              mkdir -p "$WORK_DIR" && \
              
              # 尝试通过 SSH 克隆仓库
              log "尝试通过 SSH 克隆仓库: $REPO_URL"
              if ! git clone --depth 1 --single-branch -b gh-pages "$REPO_URL" "$WORK_DIR"; then
                  log "SSH 克隆失败，尝试使用备用 HTTPS 地址克隆"
                  if ! git clone --depth 1 --single-branch -b gh-pages "$BACKUP_REPO_URL" "$WORK_DIR"; then
                      log "HTTPS 克隆也失败，退出部署"
                      python3 feishu.py --status error --message "仓库克隆失败"
                      exit 1
                  fi
                  log "使用备用 HTTPS 地址克隆成功"
              fi
              
              # 复制文件
              log "复制文件到目标目录: $TARGET_DIR"
              cp -rf "$WORK_DIR"/* "$TARGET_DIR"/ && \
              
              # 设置权限
              log "设置目标目录权限"
              chown -R 1000:1000 "$TARGET_DIR" && \
              chmod -R 644 "$TARGET_DIR" && \
              find "$TARGET_DIR" -type d -exec chmod 755 {} \; && \
              
              # 清理
              log "清理临时目录"
              rm -rf "$WORK_DIR"

              log "部署完成"
              # 如果所有命令成功执行，调用飞书脚本报告成功
              
              python3 feishu.py --status success
            } || {
              # 如果有任何命令失败，调用飞书脚本报告错误
              log "部署过程失败"
              python3 feishu.py --status error --message "部署过程出错"
            }
          timeout: 30s
